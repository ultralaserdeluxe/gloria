\setcounter{secnumdepth}{5}
\section{Huvudmodul}
Huvudmodulen kan ses som systemets "hjärna". Här sker alla beräkningar för att roboten ska kunna utföra sina uppgifter. Dessa uppgifter ska huvudmodulen hantera antingen via kommandon från en PC eller skötas helt autonomt. Detta är en kritisk modul då den kommer att utföra mycket uppgifter. Den behöver inte mycket hårdvara men den kommer vara mjukvarutung.
\subsection{Hårdvara}
Modulen ska förslagsvis bestå av en enkortsdator av modell Beagleboard. Den har en ARM Cortex-A8 processor som har en klockfrekvens på 1GHz. Denna behöver ett operativsystem för att kunna användas. Den enda hårdvaran som behövs för att kunna använda BB är ett minneskort för operativsystem och en bluetooth-dongel för kommunikationen med PC:n. För kommunikationen med styrenhet och sensorenheten behöver vi 
\subsection{Mjukvara}
Mjukvaran som behövs för att implementera all funktionalitet hos huvudmodulen kommer vara skriven i programspråket Python. Koden för programmet kommer vara trådbaserad och möjligen objektorienterad. 
\newline
Programmet ska indelas i 3 trådar. Dessa körs kontinuerligt och delar på två trådsäkra listor: sensorvärden och kommandon. I kommandolistan ligger alla argument till tillhörande kommando från PC och i sensorvärden ligger all data från sensorenheten. Listorna kan trådarna antingen läsa eller skriva till (se nedanstående bild).

\begin{figure}[h]
\scalebox{0.8}{\input{tradar}}
\caption{Trådarna och listorna de delar på}
\end{figure}

\subsubsection{Huvudtråden}
I huvudtråden ligger huvudloopen för programmet. Den börjar med att läsa värdet från kommandolistan där manuell eller autonomt läge avgörs och kallar på respektive funktion. Användaren ska alltså kunna växla mellan lägena när denne vill (mellan varje iteration av huvudloopen).
\paragraph{Autonomt läge}
\leavevmode
\newline
\newline
Här ska kod för autonom aktivitet hos systemet ligga. Sensorvärdeslistan behöver läsas av varje iteration för att avgöra om systemet befinner sig vid en av- eller upplockningsstation samt om systemet behöver regleras. Om systemet befinner sig vid en upplockningsstation behöver vi läsa av kommandolistan för att få argument om att styra armen. Om systemet befinner sig vid en avplockningsstation ska systemet låsa sig tills paket är avsläppt.
\newline 
Om systemet inte befinner sig vid en av- eller upplockningsstation skickas värden till styrenheten att köra roboten framåt. Dessa värden beräknas i slutet av programmet med regleringsalgoritmen utifrån linjesensordata från sensorvärdeslistan. 
\paragraph{Manuellt läge}
\leavevmode
\newline
\newline
I manuellt läge läses argumenten från kommandolistan av, tolkar dessa och skickar vidare lämpliga värden till styrenheten.

\begin{figure}[h]
\centering
\scalebox{0.6}{\input{huvudtrad}}
\caption{Flödesschema för huvudtråden}
\end{figure}

\subsubsection{Sensortråden}
Sensortrådens uppgift är att uppdatera sensorvärdeslistan med fräscha värden från sensorenheten.
\subsubsection{PC-tråden}
PC-tråden delar upp strängen med data från PC och lägger endast in argumenten från de olika kommandona i kommandolistan.

\subsection{Kommunikation}
\subsubsection{Huvudmodul-PC}
\subsubsection{Huvudmodul-Styrenhet}
\subsubsection{Huvudmodul-Sensorenhet}
\subsection{Reglering}
För att undvika att roboten hackar sig fram och får en smidig rörelse så ska motorns styrsignaler regleras med en tidsdiskret PD-regulator. En PID regulator är onödig då vi inte har något stående fel i teorin. Om roboten är mitt på linjen och står rakt så kommer felet vara noll. I praktiken kommer det inte vara så då roboten troligtvis inte kommer stå rakt på linejn och motorerna kommer säkert åka i olika hastigheter. Dock så blir en PD-regulator tillräckligt bra. En annan anledning till att inte ha med I-delen är att det är svårt att implementera det bra i ett tidsdiskret system. e[n] Är felet vid sampling n. 
\begin{itemize}
\item e[n] Är felet vid sampling n
\item e[n-1] Är felet vid sampling n-1
\item u[n] är styrsignalen till motorerna
\item K\_P är en konstant för den proportionella delen av regleringen
\item K\_D är en konstant för den deriverande delen av regleringen
\item Delta T är tiden mellan sampling n och n-1
 
\end{itemize}
 $$ u[n] = K_P*e[n] + K_D\frac{e[n]-e[n-1]}{\Delta T}$$
 Roboten är begränsade av hårdvaran hur ofta den kan läsa av data från reflexsensorna. Enligt handledaren är en uppdatering på 25 Hertz en rimlig nivå. Så delta T kommer vara 40ms
\subsection{hårdvara som behövs}
\begin{itemize}
\item Beagleboard-xm (finns i vanheden)
\item BT-dongle Belkin f8t016(vi har en)
\item Nivåomvandlare Ti TXB0108 ("http://www.electrokit.com/nivaomvandlare-8-kanaler.50717")
\item Minneskort (Om det inte finns i vanheden så beställ från elfa )
\item Wifi dongel för utveckling på den (vi har en)
\end{itemize}
